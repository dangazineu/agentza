# Bank Specification

The Bank application manages an in-memory ledger for customer accounts and escrow transactions, linking customer accounts to demo application identities registered via the Identity Registry. Upon startup, the Bank must register itself (as `"bank"`) with the Identity Registry.

## Endpoints

### 1. Create Account

- **HTTP Method & URL:**
  ```
  PUT /customers/{ID}/account
  ```
  where `{ID}` is the demo application's name.

- **Request Headers:**
  - `X-Signature`: A digital signature over the request body, created using the application’s private key.

- **Request Body (JSON):**
  ```json
  {
    "initialBalance": 100
  }
  ```
  Note: Each demo application begins with an account balance of 100 (interpreted as $100); the initial balance must be positive.

- **Behavior:**
  - Confirm that no account already exists for `{ID}`.
  - Retrieve the public key for `{ID}` from the Identity Registry.
  - Validate the signature on the request body using the retrieved public key.
  - Create the account if validations pass.

- **Response:**
  - Return HTTP 201 Created with account details:
  ```json
  {
    "owner": "{ID}",
    "balance": 100,
    "createdAt": "ISO-8601 timestamp of account creation"
  }
  ```

- **Error Responses:**
  - **400 Bad Request:** For malformed request body or signature header.
  - **401 Unauthorized:** If signature validation fails.
  - **409 Conflict:** If an account for `{ID}` already exists.

### 2. Create Escrow

An escrow account provides proof-of-funds when the account owner initiates a paid transaction with a recipient.

- **HTTP Method & URL:**
  ```
  POST /customers/{ID}/escrow
  ```

- **Request Headers:**
  - `X-Signature`: A signature over the JSON body generated by the application’s private key.

- **Request Body (JSON):**
  ```json
  {
    "recipient": "{RECIPIENT}",
    "amount": 10,
    "activeDurationInSeconds": 30,
    "expirationInSeconds": 10
  }
  ```
  where `{RECIPIENT}` is the name of another demo application registered in the Identity Registry.

- **Behavior:**
  - Ensure an account exists for the sender (`{ID}`).
  - Verify that the sender’s account holds sufficient funds.
  - Validate that the recipient exists in the Identity Registry.
  - Confirm that `activeDurationInSeconds` and `expirationInSeconds` are positive.
  - Deduct the escrow amount from the sender’s account and record the escrow transaction.
  - Schedule a task to return any remaining funds after `activeDurationInSeconds + expirationInSeconds`.

- **Response:**
  - Return HTTP 201 Created with the escrow account details and include a header `X-Proof-of-Funds`. The header is a base64 encoded genesis block of a microledger with:
    - A Seal that is the hash of the escrow account info.
    - A signature created using the Bank's private key.
  - Response Body (JSON):
  ```json
  {
    "escrowId": "randomly generated UUID",
    "sender": "{ID}",
    "recipient": "{RECIPIENT}",
    "amount": 10,
    "createdAt": "ISO-8601 timestamp",
    "activeDurationInSeconds": 30,
    "expirationInSeconds": 10,
    "status": "active"
  }
  ```

- **Decoded `X-Proof-of-Funds` Header Example:**
  ```json
  {
    "blockNumber": 1,
    "previousBlockHash": "",
    "digitalFingerprint": "<computed hash>",
    "timeImprint": "<ISO-8601 timestamp>",
    "controllingIdentifiers": [
      {
        "identifierType": "bank",
        "identifierValue": "bank",
        "publicKey": "<bank_public_key>"
      }
    ],
    "seals": [
      {
        "sealType": "SHA-256",
        "sealValue": "<hash of escrow account info>"
      }
    ],
    "signatures": [
      {
        "algorithm": "RSA",
        "value": "<bank signature>"
      }
    ]
  }
  ```

- **Error Responses:**
  - **400 Bad Request:** For an invalid request body.
  - **401 Unauthorized:** If signature verification fails.
  - **404 Not Found:** If sender or recipient is not registered.
  - **422 Unprocessable Entity:** If the sender does not have sufficient funds.

## Port

- The Bank application listens on port **8090**.